<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <title>Plato - lib/storage/index.js</title>

  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="">
  <meta name="author" content="">

  <!--[if lt IE 9]>
  <script src="http://html5shim.googlecode.com/svn/trunk/html5.js"></script>
  <![endif]-->

  <link href="../../assets/css/vendor/morris.css" rel="stylesheet">
  <link href="../../assets/css/vendor/bootstrap.css" rel="stylesheet">
  <link href="../../assets/css/vendor/font-awesome.css" rel="stylesheet">
  <link href="../../assets/css/vendor/codemirror.css" rel="stylesheet">
  <link href="../../assets/css/plato.css" rel="stylesheet">
  <link href="../../assets/css/plato-file.css" rel="stylesheet">

</head>

<body>

<div class="navbar navbar-fixed-top">
  <div class="container">
    <a class="navbar-brand" href="http://github.com/es-analysis/plato">Plato on Github</a>
    <ul class="nav navbar-nav">
      <li>
        <a href="../../index.html">Report Home</a>
      </li>
    </ul>
  </div>
</div>

<div class="jumbotron">
  <div class="container">
    <h1>lib/storage/index.js</h1>
  </div>
</div>

<div class="container aggregate-stats">
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Maintainability <a href="http://blogs.msdn.com/b/codeanalysis/archive/2007/11/20/maintainability-index-range-and-meaning.aspx"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="A value between 0 and 100 that represents the relative ease of maintaining the code. A high value means better maintainability." data-original-title="Maintainability Index"  data-container="body"></i></a></h2>
      <p class="stat">73.48</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Lines of code <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h2>
      <p class="stat">404</p>
    </div>
  </div>
  <div class="row historical">
    <div class="col-md-6">
      <p id="chart_historical_maint" class="chart"></p>
    </div>
    <div class="col-md-6">
      <p id="chart_historical_sloc" class="chart"></p>
    </div>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h2 class="header">Difficulty  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="The difficulty measure is related to the difficulty of the program to write or understand." data-original-title="Difficulty" data-container="body"></i></a></h2>
      <p class="stat">41.38</p>
    </div>
    <div class="col-md-6">
      <h2 class="header">Estimated Errors  <a href="http://en.wikipedia.org/wiki/Halstead_complexity_measures"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Halstead's delivered bugs is an estimate for the number of errors in the implementation." data-original-title="Delivered Bugs" data-container="body"></i></a></h2>
      <p class="stat">2.53</p>
    </div>
  </div>
</div>

<div class="container charts">
  <div class="row">
    <h2 class="header">Function weight</h2>
  </div>
  <div class="row">
    <div class="col-md-6">
      <h3 class="chart-header">By Complexity <a href="http://en.wikipedia.org/wiki/Cyclomatic_complexity"><i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="This metric counts the number of distinct paths through a block of code. Lower values are better." data-original-title="Cyclomatic Complexity" data-container="body"></i></a></h3>
      <div id="fn-by-complexity" class="stat"></div>
    </div>
    <div class="col-md-6">
      <h3 class="chart-header">By SLOC  <i class="icon icon-info-sign" rel="popover" data-placement="top" data-trigger="hover" data-content="Source Lines of Code / Logical Lines of Code" data-original-title="SLOC/LSLOC" data-container="body"></i></h3>
      <div id="fn-by-sloc" class="stat"></div>
    </div>
  </div>
</div>

<div class="container">
  <div class="row">
    <textarea id="file-source" class="col-md-12">var express = require(&#039;express&#039;);
var fs = require(&#039;fs&#039;);
var app = module.exports = express();
var parser = require(&#039;../parser/index.js&#039;);
var dre = require(&#039;../dre/index.js&#039;);
var login = require(&#039;../login&#039;);

var bb = require(&#039;blue-button&#039;);

var extractRecord = parser.extractRecord;
var record = require(&#039;blue-button-record&#039;);

//Wrapper function to save all components of an incoming object.
function saveComponents(username, masterObject, masterPartialObject, sourceID, callback) {

    var masterComplete = false;
    var masterPartialComplete = false;

    function checkComponentsComplete() {
        if (masterComplete &amp;&amp; masterPartialComplete) {
            callback(null);
        }
    }

    function saveMasterComponents(username) {

        //Set initial counter values.
        var totalSections = 0;
        var savedSections = 0;
        for (var secNum in masterObject) {
            totalSections++;
        }

        function checkSaveMasterComponentsComplete() {
            savedSections++;
            if (savedSections === totalSections) {
                masterComplete = true;
                checkComponentsComplete();
            }
        }

        for (var secName in masterObject) {
            var saveArray = masterObject[secName];
            if (saveArray.length === 0) {
                checkSaveMasterComponentsComplete();
            } else {
                record.saveSection(secName, username, saveArray, sourceID, function (err) {
                    if (err) {
                        callback(err);
                    } else {
                        checkSaveMasterComponentsComplete();
                    }
                });
            }
        }
    }

    function savePartialComponents(username) {

        //Set initial counter values.
        var totalSections = 0;
        var savedSections = 0;
        for (var secNum in masterPartialObject) {
            totalSections++;
        }

        if (totalSections === savedSections) {
            masterPartialComplete = true;
            checkComponentsComplete();
        }

        function checkSavePartialComponentsComplete() {
            savedSections++;
            if (savedSections === totalSections) {
                masterPartialComplete = true;
                checkComponentsComplete();
            }
        }

        for (var secName in masterPartialObject) {
            var saveArray = masterPartialObject[secName];

            if (saveArray.length === 0) {
                checkSavePartialComponentsComplete();
            } else {
                record.saveMatches(secName, username, saveArray, sourceID, function (err) {
                    if (err) {
                        callback(err);
                    } else {
                        checkSavePartialComponentsComplete();
                    }
                });

            }
        }
    }

    saveMasterComponents(username);
    savePartialComponents(username);

}

module.exports.saveComponents = saveComponents;

//Pull saved records from db for reconciliation.
function getSavedRecords(username, saved_sections, callback) {

    var responseObject = {};
    var responseIter = 0;
    var responseLength = saved_sections.length;

    //TODO:  Factor patient ID further up stack.
    var patient_id = username;

    function checkComplete(current_iteration) {
        responseIter++;
        if (responseIter === responseLength) {
            callback(null, responseObject);
        }
    }

    function getSavedSection(section, callback) {
        record.getSection(section, patient_id, function (err, savedObj) {
            if (err) {
                callback(err);
            } else {
                responseObject[section] = savedObj;
                callback(null);
            }
        });
    }

    for (var iSection in saved_sections) {
        getSavedSection(saved_sections[iSection], function (err) {
            if (err) {
                callback(err);
            } else {
                checkComplete();
            }
        });
    }
}

//Parses raw inbound records into components.
function parseRecord(record_type, record_data, callback) {
    var supported_formats = [&quot;ccda&quot;, &quot;c32&quot;, &quot;cda&quot;, &quot;cms&quot;, &quot;blue-button.js&quot;];
    if (record_type === &#039;application/xml&#039; || record_type === &#039;text/xml&#039; || record_type == &#039;text/plain&#039; || record_type == &#039;application/json&#039;) {
        extractRecord(record_data, function (err, format_type, parsed_record) {
            if (err) {
                callback(err);
            } else {
                if (supported_formats.indexOf(format_type) &gt;= 0) {
                    callback(null, format_type, parsed_record);
                } else {
                    callback(null, null);
                }
            }
        });
    } else {

        callback(null, null);
    }
}

//Pulls saved components from DB, reconciles with incoming.
function reconcileRecord(username, parsed_record, parsed_record_identifier, callback) {

    var sectionArray = [];

    for (var parsed_section in parsed_record) {
        sectionArray.push(parsed_section);
    }
    //console.log(&#039;section array&#039;);
    //console.log(sectionArray);

    //Get Saved Records.
    getSavedRecords(username, sectionArray, function (err, saved_record) {
        if (err) {
            callback(err);
        } else {
            //console.log(&#039;parsed records&#039;);
            //console.log(JSON.stringify(parsed_record, null, 4));
            //console.log(&#039;------------------------&#039;);
            //console.log(JSON.stringify(parsed_record, null, 4));
            //console.log(parsed_record);

            dre.reconcile(username, parsed_record, saved_record, parsed_record_identifier, function (err, reconciliation_results, partial_reconciliation_results) {
                //console.log(JSON.stringify(partial_reconciliation_results, null, 10));
                saveComponents(username, reconciliation_results, partial_reconciliation_results, parsed_record_identifier, function (err) {
                    if (err) {
                        callback(err);
                    } else {
                        callback(null);
                    }
                });
            });
        }
    });
}

//Wrapper function for all match/merge operations.
function importRecord(username, record_metadata, record_data, callback) {

    //console.log(&#039;username&#039;, username);
    //console.log(&#039;meta&#039;, record_metadata);
    //console.log(&#039;data&#039;, record_data);

    parseRecord(record_metadata.type, record_data, function (err, parsed_record_type, parsed_record) {
        if (err) {
            callback(err);
        } else if (!parsed_record_type) {
            //console.log(&quot;parsed_record&quot;, parsed_record);
            record.saveSource(username, record_data, record_metadata, null, function (err, fileInfo) {
                if (err) {
                    callback(err);
                } else {
                    callback(null, fileInfo);
                }
            });
        } else {

            //May need to wrap you.
            record.saveSource(username, record_data, record_metadata, parsed_record_type, function (err, id) {
                if (err) {
                    callback(err);
                } else {
                    //SHIM.
                    if (parsed_record.demographics) {
                        var tmpDemographicsArray = new Array(parsed_record.demographics);
                        //console.log(tmpDemographicsArray);
                        parsed_record.demographics = tmpDemographicsArray;
                    }

                    reconcileRecord(username, parsed_record, id, function (err) {
                        if (err) {
                            callback(err);
                        } else {
                            callback(null, id);
                        }
                    });
                }
            });
        }
    });
}

module.exports.importRecord = importRecord;

//Wrapper function for all match/merge operations for HL7 data.
function importHL7Record(username, record_metadata, record_data, parsed_record, callback) {

    //console.log(&#039;username&#039;, username);
    //console.log(&#039;meta&#039;, record_metadata);
    //console.log(&#039;data&#039;, record_data);

    //May need to wrap you.
    record.saveSource(username, record_data, record_metadata, &quot;hl7&quot;, function (err, id) {
        if (err) {
            callback(err);
        } else {
            //SHIM.
            if (parsed_record.demographics) {
                var tmpDemographicsArray = new Array(parsed_record.demographics);
                //console.log(tmpDemographicsArray);
                parsed_record.demographics = tmpDemographicsArray;
            }

            //TODO: add parsing of HL7 here

            reconcileRecord(username, parsed_record, id, function (err) {
                if (err) {
                    callback(err);
                } else {
                    callback(null, id);
                }
            });
        }
    });
}

module.exports.importHL7Record = importHL7Record;

//Placeholder validation function.
function validateFileMessage(requestObject, callback) {
    callback(null);
}

//Master wrapper function.
function processUpload(username, recordUpload, callback) {
    if (!recordUpload) {
        callback(&#039;Wrong object name&#039;);
    } else {
        validateFileMessage(recordUpload, function (err) {
            if (err) {
                callback(err);
            } else {
                fs.readFile(recordUpload.path, &#039;utf8&#039;, function (err, fileData) {
                    if (err) {
                        callback(err);
                    } else {
                        importRecord(username, recordUpload, fileData, function (err, import_results) {
                            if (err) {
                                callback(err);
                            } else {
                                callback(null, import_results);
                            }
                        });
                    }
                });
            }
        });
    }
}

//Retrieves a specific file for download.
app.get(&#039;/api/v1/storage/record/:identifier&#039;, login.checkAuth, function (req, res) {
    record.getSource(req.user.username, req.params.identifier, function (err, filename, returnFile) {
        if (err) {
            throw err;
        }
        record.saveEvent(&#039;fileDownloaded&#039;, req.user.username, &quot;User downloaded &#039;&quot; + filename + &quot;&#039; from My Files&quot;, req.params.identifier, function (err) {
            if (err) {
                res.status(400).send(&#039;Event error &#039; + err);
            } else {
                res.setHeader(&#039;Content-disposition&#039;, &#039;attachment; filename=&#039; + filename);
                res.status(200).send(returnFile);

            }
        });
    });
});

//Returns list of records in storage.
app.get(&#039;/api/v1/storage&#039;, login.checkAuth, function (req, res) {
    // console.log(login.checkAuth);
    record.getSourceList(req.user.username, function (err, recordList) {
        var recordResponse = {};
        recordResponse.storage = recordList;
        res.send(recordResponse);
    });
});

//Uploads a file and get demographics.
app.put(&#039;/api/v1/storage_check&#039;, login.checkAuth, function (req, res) {
    // console.log(req);
    // console.log(login.checkAuth);
    console.log(&quot;storage check api&quot;);

    //console.log(&quot;req.files &quot;, req.files);

    //var recordUpload=req.files.file;

    //console.log(&quot;recordUpload &quot;, recordUpload);

});

//Uploads a file into storage.
app.put(&#039;/api/v1/storage&#039;, login.checkAuth, function (req, res) {
    // console.log(req);
    // console.log(login.checkAuth);

    //console.log(&quot;check flag: &quot;, req.body.check);

    if (req.body.check === &quot;true&quot;) {
        fs.readFile(req.files.file.path, &#039;utf8&#039;, function (err, fileData) {
            if (err) {
                console.log(&quot;err &quot;, err);
                res.status(400).send(err);
            } else {
                //console.log(&quot;fileData&quot;, fileData);

                var data = bb.parse(fileData);

                var demographics = {
                    &quot;nothing&quot;: &quot;here&quot;
                };

                if (data.data.demographics) {
                    demographics = data.data.demographics;
                }

                //console.log(&quot;demographics &quot;, demographics);

                res.status(200).send(demographics);
            }
        });
    } else {

        processUpload(req.user.username, req.files.file, function (err) {
            if (err) {
                res.status(400).send(err);
            } else {
                record.saveEvent(&#039;fileUploaded&#039;, req.user.username, &quot;User uploaded &#039;&quot; + req.files.file.name, req.files.file.name, function (err) {
                    if (err) {
                        res.status(400).send(&#039;Event error &#039; + err);
                    } else {
                        res.status(200).end();

                    }
                });
            }
        });
    }
});</textarea>
  </div>
</div>

<footer class="footer">
  <div class="container">
    <p>.</p>
  </div>
</footer>

<script type="text/html" id="complexity-popover-template">
  <div class="complexity-notice">
    Complexity : {{ complexity.cyclomatic }} <br>
    Length : {{ complexity.halstead.length }} <br>
    Difficulty : {{ complexity.halstead.difficulty.toFixed(2) }} <br>
    Est # bugs : {{ complexity.halstead.bugs.toFixed(2) }}<br>
  </div>
</script>

<script type="text/javascript" src="../../assets/scripts/bundles/core-bundle.js"></script>
<script type="text/javascript" src="../../assets/scripts/bundles/codemirror.js"></script>
<script type="text/javascript" src="../../assets/scripts/codemirror.markpopovertext.js"></script>
<script type="text/javascript" src="report.js"></script>
<script type="text/javascript" src="report.history.js"></script>
<script type="text/javascript" src="../../assets/scripts/plato-file.js"></script>
</body>
</html>
